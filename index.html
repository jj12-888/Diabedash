<script>
/* ---------------- PAGE NAVIGATION ---------------- */

function navigateTo(pageId) {
    document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
    const page = document.getElementById('page-' + pageId);
    if (page) page.classList.add('active');

    if (pageId === 'game') {
        updatePlayerPosition();
        document.getElementById('start-modal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    } else {
        document.body.style.overflow = 'auto';
        if (gameActive) {
            stopGame();
        }
    }
}

/* ---------------- GAME STATE ---------------- */

let gameActive = false;
let playerLane = 1;
let score = 0;
let currentRound = 1;
let gameSpeed = 4;

let foodInterval, buildingInterval, cloudInterval;
let isJumping = false;
let isEating = false;

let healthyCollected = 0;
let unhealthyAvoided = 0;

const aiPlayers = [
    { id: 1, score: 0, pace: Math.random() * 5 + 3 },
    { id: 2, score: 0, pace: Math.random() * 5 + 2 }
];

const healthyFoods = ["ðŸ¥—","ðŸ¥¦","ðŸŽ","ðŸ¥‘","ðŸ¥•","ðŸ“"];
const unhealthyFoods = ["ðŸ”","ðŸ•","ðŸ©","ðŸ¦","ðŸ«","ðŸ¥¤"];

/* ---------------- DOM ---------------- */

const player = document.getElementById('player');
const gameContainer = document.getElementById('game-container');
const playerScore = document.getElementById('player-score');

/* ---------------- GAME FLOW ---------------- */

function startGame() {
    score = 0;
    healthyCollected = 0;
    unhealthyAvoided = 0;
    updateScore(0);

    aiPlayers.forEach(ai => {
        ai.score = 0;
        document.getElementById(`ai-score-${ai.id}`).textContent = 0;
    });

    gameActive = true;
    document.getElementById('start-modal').style.display = 'none';

    startFood();
    startBuildings();
    startClouds();
    startAIScore();

    document.addEventListener('keydown', handleKeys);
}

function stopGame() {
    gameActive = false;
    clearInterval(foodInterval);
    clearInterval(buildingInterval);
    clearInterval(cloudInterval);
    document.querySelectorAll('.food-item').forEach(f => f.remove());
}

function endGame() {
    stopGame();

    const scores = [score, ...aiPlayers.map(a => a.score)].sort((a,b)=>b-a);
    const rank = scores.indexOf(score) + 1;

    document.getElementById('final-score').textContent = score;
    document.getElementById('healthy-collected').textContent = healthyCollected;
    document.getElementById('unhealthy-avoided').textContent = unhealthyAvoided;
    document.getElementById('final-rank').textContent =
        rank === 1 ? "1st ðŸ†" : rank === 2 ? "2nd ðŸ¥ˆ" : "3rd ðŸ¥‰";

    document.getElementById('game-over-modal').style.display = 'flex';
}

/* ---------------- PLAYER ---------------- */

function handleKeys(e) {
    if (!gameActive) return;

    if (e.key === 'ArrowLeft' && playerLane > 0) playerLane--;
    if (e.key === 'ArrowRight' && playerLane < 2) playerLane++;
    if (e.key === 'ArrowUp' && !isJumping) jump();

    updatePlayerPosition();
}

function updatePlayerPosition() {
    const laneWidth = window.innerWidth / 3;
    player.style.left = (laneWidth * (playerLane + 0.5)) + 'px';
}

function jump() {
    isJumping = true;
    player.classList.add('jump-animation');
    setTimeout(() => {
        player.classList.remove('jump-animation');
        isJumping = false;
    }, 500);
}

/* ---------------- FOOD ---------------- */

function startFood() {
    foodInterval = setInterval(spawnFood, 900 - gameSpeed * 80);
}

function spawnFood() {
    if (!gameActive) return;

    const food = document.createElement('div');
    const healthy = Math.random() > 0.4;

    food.className = 'food-item ' + (healthy ? 'healthy' : 'unhealthy');
    food.textContent = healthy
        ? healthyFoods[Math.floor(Math.random() * healthyFoods.length)]
        : unhealthyFoods[Math.floor(Math.random() * unhealthyFoods.length)];

    const lane = Math.floor(Math.random() * 3);
    food.dataset.lane = lane;

    food.style.left = (window.innerWidth / 3) * (lane + 0.5) - 40 + 'px';
    food.style.animationDuration = (2.5 - gameSpeed * 0.15) + 's';

    gameContainer.appendChild(food);

    food.addEventListener('animationend', () => {
        if (lane === playerLane && !isJumping) {
            if (healthy) {
                updateScore(10);
                healthyCollected++;
            } else {
                updateScore(-5);
            }
        } else if (!healthy && lane === playerLane) {
            unhealthyAvoided++;
        }
        food.remove();
    });
}

/* ---------------- SCORE ---------------- */

function updateScore(change) {
    score += change;
    playerScore.textContent = score;
}

/* ---------------- BACKGROUND ---------------- */

function startBuildings() {
    buildingInterval = setInterval(() => {
        if (!gameActive) return;
        const b = document.createElement('div');
        b.className = 'building';
        b.style.height = Math.random() * 200 + 100 + 'px';
        b.style.animationDuration = (8 - gameSpeed) + 's';
        gameContainer.appendChild(b);
        b.addEventListener('animationend', () => b.remove());
    }, 2000);
}

function startClouds() {
    cloudInterval = setInterval(() => {
        if (!gameActive) return;
        const c = document.createElement('div');
        c.className = 'cloud';
        c.style.width = Math.random() * 100 + 60 + 'px';
        c.style.top = Math.random() * 200 + 'px';
        c.style.animationDuration = Math.random() * 10 + 15 + 's';
        gameContainer.appendChild(c);
        c.addEventListener('animationend', () => c.remove());
    }, 3000);
}

/* ---------------- AI PLAYERS ---------------- */

function startAIScore() {
    const interval = setInterval(() => {
        if (!gameActive) return clearInterval(interval);
        aiPlayers.forEach(ai => {
            ai.score += Math.round(ai.pace);
            document.getElementById(`ai-score-${ai.id}`).textContent = ai.score;
        });
    }, 1000);

    setTimeout(() => gameActive && endGame(), 30000);
}

/* ---------------- CHAT (LOCAL, NO AI) ---------------- */

const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');

const coachReplies = [
    "Eating fruits helps keep your energy steady during runs ðŸŽ",
    "Vegetables give your body vitamins that help muscles recover ðŸ¥•",
    "Drinking water keeps your focus sharp and prevents cramps ðŸ’§",
    "Healthy food today means stronger runs tomorrow ðŸ’ª",
    "Small smart choices add up over time â€” keep going!"
];

function openChatbot() {
    document.getElementById('chatbot-modal').style.display = 'flex';
    if (!chatMessages.children.length) addBot("Hey! Iâ€™m your healthy food coach ðŸ‘‹");
}

function closeChatbot() {
    document.getElementById('chatbot-modal').style.display = 'none';
}

function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return;

    addUser(msg);
    chatInput.value = '';

    setTimeout(() => {
        const reply = coachReplies[Math.floor(Math.random() * coachReplies.length)];
        addBot(reply);
    }, 500);
}

function addUser(text) {
    const d = document.createElement('div');
    d.className = 'message user';
    d.textContent = text;
    chatMessages.appendChild(d);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addBot(text) {
    const d = document.createElement('div');
    d.className = 'message bot';
    d.textContent = text;
    chatMessages.appendChild(d);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

/* ---------------- EVENTS ---------------- */

document.getElementById('start-game').onclick = startGame;
document.getElementById('play-again').onclick = () => {
    document.getElementById('game-over-modal').style.display = 'none';
    startGame();
};
document.getElementById('chat-with-coach').onclick = openChatbot;
document.getElementById('close-chatbot').onclick = closeChatbot;
document.getElementById('chat-send').onclick = sendMessage;
chatInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());

window.addEventListener('resize', () => gameActive && updatePlayerPosition());
</script>
