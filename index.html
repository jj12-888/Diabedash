<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiabeDash - Healthy Runner Game with Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Quicksand', sans-serif;
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #6e48aa, #9d50bb);
            height: 100vh;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        #player {
            position: absolute;
            width: 80px;
            height: 100px;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            transition: left 0.1s ease-out;
        }
        
        .lane {
            position: absolute;
            bottom: 0;
            width: 33.33%;
            height: 100%;
        }
        
        #lane-left {
            left: 0;
        }
        
        #lane-center {
            left: 33.33%;
        }
        
        #lane-right {
            left: 66.66%;
        }
        
        .food-item {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            animation: fall linear forwards;
            z-index: 50;
        }
        
        .healthy {
            background: radial-gradient(circle at 30% 30%, #a8ff78, #78ffd6);
            box-shadow: 0 0 20px rgba(168, 255, 120, 0.7);
        }
        
        .unhealthy {
            background: radial-gradient(circle at 30% 30%, #ff758c, #ff7eb3);
            box-shadow: 0 0 20px rgba(255, 117, 140, 0.7);
        }
        
        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(to bottom, #7b4397, #dc2430);
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        
        .ground-segment {
            width: 33.33%;
            height: 100%;
            border-right: 2px dashed rgba(255, 255, 255, 0.3);
            box-sizing: border-box;
        }
        
        .ground-segment:last-child {
            border-right: none;
        }
        
        .building {
            position: absolute;
            bottom: 100px;
            width: 80px;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            animation: buildingMove 8s linear infinite;
        }
        
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            filter: blur(5px);
            animation: cloudMove linear infinite;
        }
        
        @keyframes fall {
            from {
                transform: translateY(-100px);
            }
            to {
                transform: translateY(calc(100vh - 50px));
            }
        }
        
        @keyframes buildingMove {
            from {
                transform: translateX(120vw);
            }
            to {
                transform: translateX(-20vw);
            }
        }
        
        @keyframes cloudMove {
            from {
                transform: translateX(120vw);
            }
            to {
                transform: translateX(-20vw);
            }
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #43cea2, #185a9d);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        .btn {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        /* Cute human character */
        .player-character {
            width: 80px;
            height: 100px;
            position: relative;
        }
        
        .player-body {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60%;
            background: linear-gradient(135deg, #74ebd5, #ACB6E5);
            border-radius: 50% 50% 40% 40%;
            overflow: hidden;
        }
        
        .player-shirt {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60%;
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            border-radius: 40% 40% 0 0;
        }
        
        .player-head {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            height: 45%;
            background: #ffdde1;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .player-hair {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 75%;
            height: 25%;
            background: #6a4126;
            border-radius: 50% 50% 0 0;
        }
        
        .player-eye {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #333;
            border-radius: 50%;
            top: 15px;
            transition: all 0.3s ease;
        }
        
        .player-eye.left {
            left: 15px;
        }
        
        .player-eye.right {
            right: 15px;
        }
        
        .player-blush {
            position: absolute;
            width: 15px;
            height: 8px;
            background: rgba(255, 150, 150, 0.6);
            border-radius: 50%;
            top: 22px;
        }
        
        .player-blush.left {
            left: 10px;
        }
        
        .player-blush.right {
            right: 10px;
        }
        
        .player-mouth {
            position: absolute;
            width: 20px;
            height: 10px;
            background: #ff6b6b;
            border-radius: 0 0 10px 10px;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.2s ease;
        }
        
        .player-arm {
            position: absolute;
            width: 12px;
            height: 35px;
            background: #ffdde1;
            border-radius: 10px;
            top: 40%;
            transition: all 0.3s ease;
        }
        
        .player-arm.left {
            left: -5px;
            transform: rotate(-20deg);
        }
        
        .player-arm.right {
            right: -5px;
            transform: rotate(20deg);
        }
        
        .player-leg {
            position: absolute;
            width: 15px;
            height: 25px;
            background: #ffdde1;
            border-radius: 10px;
            bottom: -15px;
        }
        
        .player-leg.left {
            left: 20px;
        }
        
        .player-leg.right {
            right: 20px;
        }
        
        .jump-animation {
            animation: jump 0.5s ease-out;
        }
        
        @keyframes jump {
            0% { transform: translateY(0) translateX(-50%); }
            50% { transform: translateY(-120px) translateX(-50%); }
            100% { transform: translateY(0) translateX(-50%); }
        }
        
        /* Eating animations */
        .eating-animation {
            animation: eating 0.5s ease-in-out;
        }
        
        @keyframes eating {
            0% { height: 10px; width: 20px; }
            50% { height: 20px; width: 30px; border-radius: 50%; }
            100% { height: 10px; width: 20px; }
        }
        
        .happy-eyes {
            animation: happyEyes 0.5s ease-in-out;
        }
        
        @keyframes happyEyes {
            0% { height: 10px; }
            50% { height: 2px; border-radius: 50%; top: 20px; }
            100% { height: 10px; }
        }
        
        .sad-eyes {
            animation: sadEyes 0.5s ease-in-out;
        }
        
        @keyframes sadEyes {
            0% { height: 10px; border-radius: 50%; }
            50% { height: 15px; border-radius: 50% 50% 0 0; top: 12px; }
            100% { height: 10px; border-radius: 50%; }
        }
        
        .food-eaten {
            animation: foodEaten 0.5s ease-in-out forwards;
            z-index: 90;
        }
        
        @keyframes foodEaten {
            0% { transform: scale(1); }
            100% { 
                transform: scale(0.2); 
                opacity: 0;
            }
        }
        
        .arm-eating-left {
            animation: armEatingLeft 0.5s ease-in-out;
        }
        
        @keyframes armEatingLeft {
            0% { transform: rotate(-20deg); }
            50% { transform: rotate(-40deg) translateY(-5px); }
            100% { transform: rotate(-20deg); }
        }
        
        .arm-eating-right {
            animation: armEatingRight 0.5s ease-in-out;
        }
        
        @keyframes armEatingRight {
            0% { transform: rotate(20deg); }
            50% { transform: rotate(40deg) translateY(-5px); }
            100% { transform: rotate(20deg); }
        }
        
        .score-popup {
            position: absolute;
            font-weight: bold;
            font-size: 30px;
            animation: scorePopup 1s ease-out forwards;
            z-index: 200;
        }
        
        @keyframes scorePopup {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-70px); }
        }
        
        .multiplayer-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            color: white;
            max-width: 200px;
            z-index: 500;
        }
        
        .player-entry {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .player-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .round-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            z-index: 500;
        }
        
        .round-pill {
            display: inline-block;
            width: 30px;
            height: 10px;
            border-radius: 5px;
            margin: 0 5px;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .round-pill.active {
            background: white;
        }
        
        .game-over-stats {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        /* AI Chatbot Styles */
        .chatbot-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }
        
        .chatbot-container {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        .chatbot-header {
            padding: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px 20px 0 0;
        }
        
        .chatbot-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin: 0 auto 10px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            animation: messageSlide 0.3s ease-out;
            white-space: pre-wrap; /* Allows for line breaks in Gemini's response */
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.bot {
            background: rgba(255, 255, 255, 0.2);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .message.user {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: #333;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .chat-input-area {
            padding: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0 0 20px 20px;
        }
        
        .quick-responses {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .quick-response-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quick-response-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            outline: none;
        }
        
        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .chat-send-btn {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: #333;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.1);
        }
        
        .chat-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chat-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            max-width: 80px;
            align-self: flex-start;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: typingDot 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="ground">
            <div class="ground-segment"></div>
            <div class="ground-segment"></div>
            <div class="ground-segment"></div>
        </div>
        
        <div id="lane-left" class="lane"></div>
        <div id="lane-center" class="lane"></div>
        <div id="lane-right" class="lane"></div>
        
        <div id="player">
            <div class="player-character">
                <div class="player-head">
                    <div class="player-hair"></div>
                    <div class="player-eye left"></div>
                    <div class="player-eye right"></div>
                    <div class="player-blush left"></div>
                    <div class="player-blush right"></div>
                    <div class="player-mouth"></div>
                </div>
                <div class="player-body">
                    <div class="player-shirt"></div>
                    <div class="player-arm left"></div>
                    <div class="player-arm right"></div>
                    <div class="player-leg left"></div>
                    <div class="player-leg right"></div>
                </div>
            </div>
        </div>
        
        <div class="round-indicator">
            <div>Round <span id="current-round">1</span>/3</div>
            <div class="mt-2">
                <span class="round-pill active"></span>
                <span class="round-pill"></span>
                <span class="round-pill"></span>
            </div>
        </div>
        
        <div class="multiplayer-panel">
            <h3 class="text-lg font-bold mb-2">Leaderboard</h3>
            <div id="leaderboard">
                <div class="player-entry">
                    <div class="player-avatar">Y</div>
                    <div>You: <span id="player-score">0</span> ‚Çπ</div>
                </div>
                <div class="player-entry">
                    <div class="player-avatar">A</div>
                    <div>AI 1: <span id="ai-score-1">0</span> ‚Çπ</div>
                </div>
                <div class="player-entry">
                    <div class="player-avatar">A</div>
                    <div>AI 2: <span id="ai-score-2">0</span> ‚Çπ</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="start-modal" class="modal">
        <div class="modal-content">
            <h1 class="text-3xl font-bold mb-4">DiabeDash</h1>
            <p class="mb-6">Navigate through a vibrant world collecting healthy foods for +10 coins while avoiding unhealthy ones that cost you -5 coins!</p>
            
            <div class="mb-6">
                <p class="font-bold mb-2">How to play:</p>
                <p>‚Üê ‚Üí Arrow keys to move between lanes</p>
                <p>‚Üë Arrow key to jump</p>
            </div>
            
            <button id="start-game" class="btn">Start Game</button>
        </div>
    </div>
    
    <div id="round-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Round <span id="round-number">1</span> Complete!</h2>
            <p class="mb-4">Your score: <span id="round-score">0</span> ‚Çπ</p>
            <button id="next-round" class="btn">Next Round</button>
        </div>
    </div>
    
    <div id="game-over-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Game Over!</h2>
            <p class="mb-4">Final Score: <span id="final-score">0</span> ‚Çπ</p>
            
            <div class="game-over-stats">
                <h3 class="text-lg font-bold mb-2">Game Stats</h3>
                <div class="stat-row">
                    <span>Healthy foods collected:</span>
                    <span id="healthy-collected">0</span>
                </div>
                <div class="stat-row">
                    <span>Unhealthy foods avoided:</span>
                    <span id="unhealthy-avoided">0</span>
                </div>
                <div class="stat-row">
                    <span>Final Ranking:</span>
                    <span id="final-rank">1st</span>
                </div>
            </div>
            
            <button id="play-again" class="btn">Play Again</button>
            <button id="chat-with-coach" class="btn">Chat with Healthy Coach ü•ó</button>
        </div>
    </div>
    
    <div id="chatbot-modal" class="chatbot-modal" style="display: none;">
        <div class="chatbot-container">
            <button class="chat-close-btn" id="close-chatbot">√ó</button>
            <div class="chatbot-header">
                <div class="chatbot-avatar">ü§ñ</div>
                <h3>Gemini Healthy Coach</h3>
                <p style="font-size: 14px; opacity: 0.8;">Hi! I'm your AI Coach, powered by Gemini. Ask me anything!</p>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                </div>
            
            <div class="chat-input-area">
                <div class="quick-responses" id="quick-responses">
                    <button class="quick-response-btn" data-response="What are healthy snacks?">Healthy Snacks üçé</button>
                    <button class="quick-response-btn" data-response="Tell me about vegetables">About Veggies ü•ï</button>
                    <button class="quick-response-btn" data-response="Why should I drink water?">Why Water? üíß</button>
                    <button class="quick-response-btn" data-response="Fun food facts please!">Fun Facts üåü</button>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Ask me about healthy eating...">
                    <button class="chat-send-btn" id="chat-send">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GEMINI CHATBOT CONFIGURATION ---
        // ‚ö†Ô∏è WARNING: DO NOT USE THIS METHOD IN PRODUCTION. API KEYS MUST BE KEPT SECRET.
        // For a public app, use a server proxy to hide your key.
        const GEMINI_API_KEY = "AIzaSyCyAFRkjMYPy17d9kvTZRkpUjAPyxQYo-k"; 
        const GEMINI_MODEL = "gemini-2.5-flash";
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        
        // This array will store the conversation history for multi-turn chat
        let chatHistory = [];
        const SYSTEM_INSTRUCTION = "You are the Healthy Eating Coach for a runner game called DiabeDash. Your goal is to provide encouraging, short, and accurate advice about healthy eating, especially for kids and runners. Your tone must be upbeat and positive. For example, if a user asks about healthy snacks, give them a fun, short list. Always keep your response fun and enthusiastic.";
        // ------------------------------------

        // Game variables
        let gameActive = false;
        let playerLane = 1; // 0: left, 1: center, 2: right
        let score = 0;
        let currentRound = 1;
        let gameSpeed = 4; // Increased base speed
        let foodInterval;
        let buildingInterval;
        let cloudInterval;
        let isJumping = false;
        let isEating = false;
        let healthyCollected = 0;
        let unhealthyAvoided = 0;
        let totalUnhealthy = 0;
        
        // AI players
        const aiPlayers = [
            { id: 1, score: 0, scoreIncrement: Math.random() * 5 + 3 },
            { id: 2, score: 0, scoreIncrement: Math.random() * 5 + 2 }
        ];
        
        // Food items data (rest of the game logic is unchanged)
        const healthyFoods = [
            { emoji: "ü•ó", name: "Salad" },
            { emoji: "ü•¶", name: "Broccoli" },
            { emoji: "üçé", name: "Apple" },
            { emoji: "ü•ë", name: "Avocado" },
            { emoji: "ü•ï", name: "Carrot" },
            { emoji: "üçì", name: "Strawberry" },
            { emoji: "ü•ù", name: "Kiwi" }
        ];
        
        const unhealthyFoods = [
            { emoji: "üçî", name: "Burger" },
            { emoji: "üçï", name: "Pizza" },
            { emoji: "üç©", name: "Donut" },
            { emoji: "üç¶", name: "Ice Cream" },
            { emoji: "üç´", name: "Chocolate" },
            { emoji: "ü•§", name: "Soda" }
        ];
        
        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const player = document.getElementById('player');
        const startModal = document.getElementById('start-modal');
        const roundModal = document.getElementById('round-modal');
        const gameOverModal = document.getElementById('game-over-modal');
        const playerScoreElement = document.getElementById('player-score');
        const aiScore1Element = document.getElementById('ai-score-1');
        const aiScore2Element = document.getElementById('ai-score-2');
        const currentRoundElement = document.getElementById('current-round');
        
        // Player character elements
        const playerMouth = document.querySelector('.player-mouth');
        const playerEyeLeft = document.querySelector('.player-eye.left');
        const playerEyeRight = document.querySelector('.player-eye.right');
        const playerArmLeft = document.querySelector('.player-arm.left');
        const playerArmRight = document.querySelector('.player-arm.right');
        
        // Chatbot elements
        const chatbotModal = document.getElementById('chatbot-modal');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const quickResponseBtns = document.querySelectorAll('.quick-response-btn');

        // Event Listeners (Unchanged)
        document.getElementById('start-game').addEventListener('click', startGame);
        document.getElementById('next-round').addEventListener('click', startNextRound);
        document.getElementById('play-again').addEventListener('click', resetGame);
        document.getElementById('chat-with-coach').addEventListener('click', openChatbot);
        document.getElementById('close-chatbot').addEventListener('click', closeChatbot);
        document.getElementById('chat-send').addEventListener('click', sendMessage);
        document.getElementById('chat-input').addEventListener('keypress', handleChatKeyPress);
        
        // Quick response buttons (Unchanged)
        quickResponseBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const response = btn.dataset.response;
                chatInput.value = response;
                sendMessage();
            });
        });
        
        // --- GAME LOGIC FUNCTIONS (Unchanged) ---
        function startGame() {
            startModal.style.display = 'none';
            gameActive = true;
            score = 0;
            updateScore();
            
            aiPlayers.forEach(ai => {
                ai.score = 0;
                document.getElementById(`ai-score-${ai.id}`).textContent = '0';
            });
            
            startGeneratingFood();
            startGeneratingBuildings();
            startGeneratingClouds();
            startUpdatingAIScores();
            
            document.addEventListener('keydown', handleKeyPress);
        }
        
        function startNextRound() {
            roundModal.style.display = 'none';
            currentRound++;
            currentRoundElement.textContent = currentRound;
            
            const roundPills = document.querySelectorAll('.round-pill');
            roundPills.forEach((pill, index) => {
                pill.classList.toggle('active', index < currentRound);
            });
            
            gameSpeed += 0.8;
            
            gameActive = true;
            startGeneratingFood();
            startGeneratingBuildings();
            startGeneratingClouds();
            startUpdatingAIScores();
        }
        
        function resetGame() {
            gameOverModal.style.display = 'none';
            currentRound = 1;
            currentRoundElement.textContent = currentRound;
            gameSpeed = 4;
            score = 0;
            healthyCollected = 0;
            unhealthyAvoided = 0;
            totalUnhealthy = 0;
            
            const roundPills = document.querySelectorAll('.round-pill');
            roundPills.forEach((pill, index) => {
                pill.classList.toggle('active', index === 0);
            });
            
            aiPlayers.forEach(ai => {
                ai.score = 0;
                ai.scoreIncrement = Math.random() * 5 + 2;
                document.getElementById(`ai-score-${ai.id}`).textContent = '0';
            });
            
            updateScore();
            startGame();
        }
        
        function endRound() {
            gameActive = false;
            clearInterval(foodInterval);
            clearInterval(buildingInterval);
            clearInterval(cloudInterval);
            
            document.querySelectorAll('.food-item').forEach(item => item.remove());
            
            if (currentRound < 3) {
                document.getElementById('round-number').textContent = currentRound;
                document.getElementById('round-score').textContent = score;
                roundModal.style.display = 'flex';
            } else {
                endGame();
            }
        }
        
        function endGame() {
            const allScores = [score, ...aiPlayers.map(ai => ai.score)].sort((a, b) => b - a);
            const playerRank = allScores.indexOf(score) + 1;
            let rankText;
            
            switch(playerRank) {
                case 1: rankText = "1st Place üèÜ"; break;
                case 2: rankText = "2nd Place ü•à"; break;
                case 3: rankText = "3rd Place ü•â"; break;
                default: rankText = `${playerRank}th Place`;
            }
            
            document.getElementById('final-score').textContent = score;
            document.getElementById('healthy-collected').textContent = healthyCollected;
            document.getElementById('unhealthy-avoided').textContent = unhealthyAvoided;
            document.getElementById('final-rank').textContent = rankText;
            
            gameOverModal.style.display = 'flex';
        }
        
        function handleKeyPress(e) {
            if (!gameActive) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    if (playerLane > 0) {
                        playerLane--;
                        updatePlayerPosition();
                    }
                    break;
                case 'ArrowRight':
                    if (playerLane < 2) {
                        playerLane++;
                        updatePlayerPosition();
                    }
                    break;
                case 'ArrowUp':
                    if (!isJumping) {
                        jump();
                    }
                    break;
            }
        }
        
        function updatePlayerPosition() {
            const laneWidth = window.innerWidth / 3;
            const lanePositions = [
                laneWidth * 0.5,
                laneWidth * 1.5,
                laneWidth * 2.5
            ];
            
            player.style.left = `${lanePositions[playerLane]}px`;
        }
        
        function jump() {
            isJumping = true;
            player.classList.add('jump-animation');
            
            setTimeout(() => {
                player.classList.remove('jump-animation');
                isJumping = false;
            }, 500);
        }
        
        function playEatingAnimation(isHealthy) {
            if (isEating) return;
            isEating = true;
            
            playerMouth.classList.add('eating-animation');
            playerArmLeft.classList.add('arm-eating-left');
            playerArmRight.classList.add('arm-eating-right');
            
            if (isHealthy) {
                playerEyeLeft.classList.add('happy-eyes');
                playerEyeRight.classList.add('happy-eyes');
            } else {
                playerEyeLeft.classList.add('sad-eyes');
                playerEyeRight.classList.add('sad-eyes');
            }
            
            setTimeout(() => {
                playerMouth.classList.remove('eating-animation');
                playerArmLeft.classList.remove('arm-eating-left');
                playerArmRight.classList.remove('arm-eating-right');
                playerEyeLeft.classList.remove('happy-eyes', 'sad-eyes');
                playerEyeRight.classList.remove('happy-eyes', 'sad-eyes');
                isEating = false;
            }, 500);
        }
        
        function startGeneratingFood() {
            const minInterval = 1000 - (gameSpeed * 100);
            const maxInterval = 2000 - (gameSpeed * 150);
            
            const generateAndScheduleNext = () => {
                if (!gameActive) return;
                
                generateFoodItem();
                
                clearInterval(foodInterval);
                const nextInterval = Math.random() * (maxInterval - minInterval) + minInterval;
                foodInterval = setTimeout(generateAndScheduleNext, nextInterval);
            }
            
            // Initial call
            generateAndScheduleNext();
        }
        
        function generateFoodItem() {
            const foodItem = document.createElement('div');
            const isHealthy = Math.random() > 0.4;
            const foodArray = isHealthy ? healthyFoods : unhealthyFoods;
            const food = foodArray[Math.floor(Math.random() * foodArray.length)];
            
            foodItem.className = `food-item ${isHealthy ? 'healthy' : 'unhealthy'}`;
            foodItem.innerHTML = food.emoji;
            foodItem.dataset.type = isHealthy ? 'healthy' : 'unhealthy';
            foodItem.dataset.name = food.name;
            
            const lane = Math.floor(Math.random() * 3);
            const laneWidth = window.innerWidth / 3;
            const laneCenter = laneWidth * (lane + 0.5);
            
            foodItem.style.left = `${laneCenter - 40}px`;
            
            const fallDuration = 2.5 - (gameSpeed * 0.2);
            foodItem.style.animationDuration = `${fallDuration}s`;
            
            gameContainer.appendChild(foodItem);
            
            if (!isHealthy) totalUnhealthy++;
            
            foodItem.addEventListener('animationend', () => {
                if (lane === playerLane) {
                    if (!isJumping) {
                        if (isHealthy) {
                            updateScore(10);
                            healthyCollected++;
                            showScorePopup(foodItem, '+10', 'text-green-400');
                            playEatingAnimation(true);
                            animateFoodBeingEaten(foodItem);
                        } else {
                            updateScore(-5);
                            showScorePopup(foodItem, '-5', 'text-red-400');
                            playEatingAnimation(false);
                            animateFoodBeingEaten(foodItem);
                        }
                    } else if (!isHealthy) {
                        unhealthyAvoided++;
                        foodItem.remove();
                    } else {
                        foodItem.remove();
                    }
                } else if (!isHealthy) {
                    unhealthyAvoided++;
                    foodItem.remove();
                } else {
                    foodItem.remove();
                }
            });
        }
        
        function animateFoodBeingEaten(foodItem) {
            const playerRect = player.getBoundingClientRect();
            const foodRect = foodItem.getBoundingClientRect();
            
            const distanceX = (playerRect.left + playerRect.width/2) - (foodRect.left + foodRect.width/2);
            const distanceY = (playerRect.top + playerRect.height/3) - (foodRect.top + foodRect.height/2);
            
            foodItem.style.position = 'fixed';
            foodItem.style.top = `${foodRect.top}px`;
            foodItem.style.left = `${foodRect.left}px`;
            foodItem.style.transform = 'none';
            foodItem.style.animation = 'none';
            foodItem.style.transition = 'all 0.3s ease-in-out';
            
            setTimeout(() => {
                foodItem.style.transform = `translate(${distanceX}px, ${distanceY}px) scale(0.5)`;
                foodItem.style.opacity = '0.8';
                
                setTimeout(() => {
                    foodItem.remove();
                }, 300);
            }, 10);
        }
        
        function showScorePopup(element, text, colorClass) {
            const popup = document.createElement('div');
            popup.className = `score-popup ${colorClass}`;
            popup.textContent = text;
            
            const rect = element.getBoundingClientRect();
            popup.style.left = `${rect.left}px`;
            popup.style.top = `${rect.top - 20}px`;
            
            gameContainer.appendChild(popup);
            
            popup.addEventListener('animationend', () => {
                popup.remove();
            });
        }
        
        function updateScore(points = 0) {
            score += points;
            playerScoreElement.textContent = score;
        }
        
        function startGeneratingBuildings() {
            buildingInterval = setInterval(() => {
                if (!gameActive) return;
                
                const building = document.createElement('div');
                building.className = 'building';
                
                const height = Math.random() * 200 + 100;
                const width = Math.random() * 60 + 40;
                const hue = Math.random() * 60 + 200;
                
                building.style.height = `${height}px`;
                building.style.width = `${width}px`;
                building.style.background = `hsla(${hue}, 70%, 40%, 0.3)`;
                building.style.left = `${Math.random() * 20 + 100}%`;
                building.style.animationDuration = `${8 - gameSpeed}s`;
                
                gameContainer.appendChild(building);
                
                building.addEventListener('animationend', () => {
                    building.remove();
                });
                
            }, 2000);
        }
        
        function startGeneratingClouds() {
            cloudInterval = setInterval(() => {
                if (!gameActive) return;
                
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                
                const size = Math.random() * 100 + 50;
                const top = Math.random() * 200 + 20;
                const opacity = Math.random() * 0.3 + 0.1;
                
                cloud.style.width = `${size}px`;
                cloud.style.height = `${size * 0.6}px`;
                cloud.style.top = `${top}px`;
                cloud.style.opacity = opacity;
                cloud.style.animationDuration = `${Math.random() * 10 + 15}s`;
                
                gameContainer.appendChild(cloud);
                
                cloud.addEventListener('animationend', () => {
                    cloud.remove();
                });
                
            }, 3000);
        }
        
        function startUpdatingAIScores() {
            const aiScoreInterval = setInterval(() => {
                if (!gameActive) {
                    clearInterval(aiScoreInterval);
                    return;
                }
                
                aiPlayers.forEach(ai => {
                    const increment = ai.scoreIncrement * (0.8 + Math.random() * 0.4);
                    ai.score += Math.round(increment);
                    document.getElementById(`ai-score-${ai.id}`).textContent = ai.score;
                });
                
            }, 1000);
            
            setTimeout(() => {
                if (gameActive) {
                    endRound();
                }
            }, 30000);
        }
        
        updatePlayerPosition();
        window.addEventListener('resize', updatePlayerPosition);
        
        let touchStartX = 0;
        gameContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });
        
        gameContainer.addEventListener('touchend', (e) => {
            if (!gameActive) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchDiff = touchEndX - touchStartX;
            
            if (Math.abs(touchDiff) > 50) {
                if (touchDiff > 0 && playerLane < 2) {
                    playerLane++;
                    updatePlayerPosition();
                } else if (touchDiff < 0 && playerLane > 0) {
                    playerLane--;
                    updatePlayerPosition();
                }
            } else {
                if (!isJumping) {
                    jump();
                }
            }
        });
        
        // --- GEMINI CHATBOT FUNCTIONS (MODIFIED) ---

        function openChatbot() {
            chatbotModal.style.display = 'flex';
            if (chatMessages.children.length === 0) {
                // Initial welcome message from the coach
                addBotMessage("Hi there! I'm your Gemini Healthy Coach ü§ñ. I can give you fun, quick advice about healthy eating, especially for running and playing! What can I help you with?");
            }
        }
        
        function closeChatbot() {
            chatbotModal.style.display = 'none';
        }
        
        function handleChatKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }
        
        // ASYNC function to send message to the Gemini API
        async function generateGeminiResponse(userMessage) {
            
            if (GEMINI_API_KEY === "AIzaSyCyAFRkjMYPy17d9kvTZRkpUjAPyxQYo-k") {
                return "Please replace 'AIzaSyCyAFRkjMYPy17d9kvTZRkpUjAPyxQYo-k' in the script with your actual Gemini API Key to enable the AI coach!";
            }
            
            // Add the user's message to the chat history
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            
            const payload = {
                contents: chatHistory,
                config: {
                    systemInstruction: SYSTEM_INSTRUCTION
                }
            };
            
            try {
                const response = await fetch(GEMINI_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Get the response text from the Gemini JSON structure
                const botResponse = data.candidates[0].content.parts[0].text;
                
                // Add the bot's response to the chat history
                chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                
                return botResponse;
                
            } catch (error) {
                console.error("Gemini API Error:", error);
                // Remove the user message on error to avoid polluting history
                chatHistory.pop(); 
                return "Oops! My connection to the AI kitchen got blocked! Try again in a moment, or check the console for API errors.";
            }
        }

        // Modified sendMessage to be asynchronous and call Gemini
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // 1. Add user message to UI
            addUserMessage(message);
            chatInput.value = '';
            
            // 2. Show typing indicator
            showTypingIndicator();
            
            // 3. Call Gemini (AWAIT the response)
            const response = await generateGeminiResponse(message);
            
            // 4. Hide typing indicator
            hideTypingIndicator();
            
            // 5. Add bot response to UI
            addBotMessage(response);
        }
        
        function addUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function addBotMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // The original static response logic is removed entirely.
    </script>
</body>

</html>
